<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnswerIT!! - Setup & Configuration</title>
    <link rel="icon" href="https://i.pinimg.com/736x/d9/b5/a6/d9b5a64b2a0f432e41f611ddd410d8be.jpg">
    <link rel="stylesheet" href="configure.css">
    <script src="https://unpkg.com/psl@latest/dist/psl.umd.cjs"></script>
</head>
<body>
    <div class="hero">
        <button id="themeToggle" class="theme-toggle" title="Toggle theme">üåô</button>
        <h1>üéØ AnswerIT!!</h1>
        <p>Setup your AI-powered answer generator and configure your preferences</p>
        <div id="detectionStatus" class="detection-status">üîç Detecting userscript...</div>
    </div>

    <div class="container">
        <div class="grid">
            <div class="card">
                <div class="card-icon">üìö</div>
                <h2>How to Use</h2>
                <p>Get started with AnswerIT!! in just a few steps</p>
                <div style="text-align: left; margin-top: 1rem;">
                    <div style="margin-bottom: 1rem;"><strong style="color: var(--primary);">Step 1:</strong> Get your free Gemini API key</div>
                    <div style="margin-bottom: 1rem;"><strong style="color: var(--primary);">Step 2:</strong> Enter your API key above</div>
                    <div style="margin-bottom: 1rem;"><strong style="color: var(--primary);">Step 3:</strong> Configure your preferences</div>
                    <div style="margin-bottom: 1rem;"><strong style="color: var(--primary);">Step 4:</strong> Use <span id="modifierKey">Alt</span> + [hotkey] on supported sites</div>
                </div>
                <div class="quick-links">
                    <a href="https://github.com/NytLyt512/Userscripts/tree/main/AnswerIT!!" target="_blank" class="quick-link">üìñ Github Page</a>
                    <a href="https://github.com/NytLyt512/Userscripts/issues/new?title=[AnswerIT!!]%20**Title%20of%20the%20issue**%20&body=**Describe%20the%20issue:**%0A%0A**Steps%20to%20reproduce:**%0A%0A**Expected%20behavior:**%0A%0A**Screenshots%20(optional):**%0A%0A**Environment:**%0A-%20Browser:%0A-%20OS:%0A" target="_blank" class="quick-link">üêõ Report Issues</a>
                </div>
                <button class="btn btn-primary" id="installScript" style="margin-top: 1rem;">
                    <span class="hidden">‚¨áÔ∏è Install UserScript</span>
                    <span class="hidden">‚úÖ Userscript Installed!!</span>
                    <div class="spinner"></div>
                </button>
            </div>

            <div class="card">
                <div class="card-icon">üîë</div>
                <h2>API Key Setup</h2>
                <p>Configure your Gemini API key to start using AI-powered answers</p>
                <div class="status" id="apiStatus"></div>
                <form id="apiForm">
                    <div class="form-group">
                        <label class="form-label">Gemini API Key</label>
                        <input type="password" id="apiKey" class="form-input" placeholder="Enter your Gemini API key..."
                            autocomplete="off">
                        <div class="help-text">Your API key is stored securely and never sent to our servers.</div>
                    </div>
                    <div class="quick-links">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="quick-link">üîó Get Free
                            API Key</a>
                        <a href="#" id="testKey" class="quick-link">üß™ Test API Key</a>
                    </div>
                    <button type="submit" class="btn btn-primary" id="saveApi" style="margin-top: 1rem;">
                        <span>Save API Key</span>
                    </button>
                </form>
            </div>
        <!-- </div> -->

        <!-- <div class="grid" style="margin-top: 2rem;"> -->
            <div class="card">
                <div class="card-icon">‚öôÔ∏è</div>
                <h2>Preferences</h2>
                <p>Customize your AnswerIT!! experience</p>
                <div class="status" id="preferencesStatus"></div>
                <form id="settingsForm">
                    <div class="preferences-grid">
                        <div class="form-group">
                            <label class="form-label">üî• Hotkey</label>
                            <select id="hotkey" class="form-input">
                                <option value="a"><span id="hotkeyModifier">Alt</span> + A</option>
                                <option value="q"><span id="hotkeyModifier">Alt</span> + Q</option>
                                <option value="z"><span id="hotkeyModifier">Alt</span> + Z</option>
                                <option value="x"><span id="hotkeyModifier">Alt</span> + X</option>
                            </select>
                            <div class="help-text">Keyboard shortcut to activate AnswerIT!!</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Theme</label>
                            <select id="theme" class="form-input">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">Auto (System)</option>
                            </select>
                            <div class="help-text">Choose your preferred theme for the popup</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="makeAIOutputEditable" class="toggle-input">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Make AI Output Editable</span>
                        </label>
                        <div class="help-text">Allow editing within the AI-generated output textarea to be able to modify the response before inserting it.</div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="saveSettings" style="margin-top: 1rem;">
                        <span id="saveSettingsText">Save Settings</span>
                        <div class="spinner" id="saveSettingsSpinner" style="display: none;"></div>
                    </button>
                </form>
            </div>

            <!-- Reflector Mode Setup Section -->
            <div class="card" id="reflectorCard">
                <div class="card-icon">üñ•Ô∏è</div>
                <h2>Reflector Mode Setup</h2>
                <p>Mirror your host device's question area to another device in real time.<br>Use this section to set up and connect your devices.</p>
                <div class="status" id="reflectorStatus"></div>
                <div class="form-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="reflectorEnable" class="toggle-input">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Enable Reflector Mode (Host)</span>
                    </label>
                    <div class="help-text">Turn on to start broadcasting your question area.</div>
                </div>
                <div id="reflectorOfferSection" style="display:none;">
                    <label class="form-label">Your Offer (Host)</label>
                    <textarea id="reflectorOffer" class="form-input" rows="4" readonly></textarea>
                    <div style="margin:0.5rem 0;">
                        <button class="btn btn-secondary" id="copyOfferBtn">Copy Offer</button>
                        <button class="btn btn-secondary" id="showOfferQRBtn">Show QR</button>
                        <span id="offerQRContainer" style="display:none; margin-left:1rem;"></span>
                    </div>
                    <div class="help-text">Share this offer with your reflector device (scan QR or copy text).</div>
                </div>
                <div id="reflectorAnswerSection" style="display:none; margin-top:1rem;">
                    <label class="form-label">Paste Answer from Reflector Device</label>
                    <textarea id="reflectorAnswer" class="form-input" rows="4" placeholder="Paste answer here..."></textarea>
                    <button class="btn btn-primary" id="submitAnswerBtn" style="margin-top:0.5rem;">Submit Answer</button>
                    <div class="help-text">Paste the answer code from the reflector device to complete the connection.</div>
                </div>
                <div id="reflectorStatusMsg" style="margin-top:1rem; font-weight:600;"></div>
                <button class="btn btn-primary" id="gotoReflectorBtn" style="margin-top:2rem;">Open Reflector Page</button>
            </div>
        </div>

        <div class="sites-section">
            <h2>üåê Supported Learning Platforms</h2>
            <p>AnswerIT!! works seamlessly with these platforms. Click any site to visit it directly.</p>
            <div class="sites-grid" id="sitesGrid"></div>
        </div>
    </div>

    <!-- Include jQuery from a CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        function showStatus(id, message, type) {
            const $el = $(`#${id}`);
            $el.text(message);
            $el.attr('class', `status ${type}`);
            $el.css('display', 'flex');
            if (type === 'success') {
                setTimeout(() => $el.css('display', 'none'), 5000);
            }
        }

        class ConfigManager {
            constructor() {
                this.currentTheme = localStorage.getItem('pageTheme') || 'light';
                this.isMac = !navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                this.configDetected = false;
                this.GM = {
                    getValue: window.AnswerIT_Config?.GM_getValue,
                    setValue: window.AnswerIT_Config?.GM_setValue,
                };
                this.theme.initTheme();
                this.initEventListeners();
                this.detectUserscript();
            }

            theme = {
                initTheme: () => {
                    this.theme.applyTheme(this.currentTheme);
                    const $toggle = $('#themeToggle');
                    $toggle.text(this.currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è');
                    $toggle.attr('title', `Switch to ${this.currentTheme === 'light' ? 'dark' : 'light'} theme`);
                },
                toggleTheme: () => {
                    this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                    this.theme.applyTheme(this.currentTheme);
                    const $toggle = $('#themeToggle');
                    $toggle.text(this.currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è');
                    $toggle.attr('title', `Switch to ${this.currentTheme === 'light' ? 'dark' : 'light'} theme`);
                },
                applyTheme: (theme) => {
                    document.documentElement.classList.toggle('dark', theme === 'dark');
                    localStorage.setItem('pageTheme', theme);
                }
            }

            detectUserscript() {
                console.log('[ConfigPage] Starting userscript detection...');
                updateDetectionStatus('üîç Detecting userscript...', '');

                let attempts = 0, max = 15;
                const poll = () => {
                    attempts++;
                    updateDetectionStatus(`üîç Checking for userscript... (${attempts}/${max})`, '');
                    if (window.AnswerIT_Config?.GM_getValue) {
                        updateDetectionStatus('‚úÖ Userscript connected!', 'success');
                        onConfigDetected(this);
                    } else if (attempts < max) {
                        setTimeout(poll, Math.min(100 * 2 ** (attempts - 1), 2000));
                    } else {
                        updateDetectionStatus('‚ö†Ô∏è Couldn\'t detect userscript.', 'warning');
                    }
                }; poll();
                
                function updateDetectionStatus(message, type) {
                    const $status = $('#detectionStatus');
                    $status.text(message);
                    $status.attr('class', `detection-status ${type}`);
                    // Hide status after successful connection
                    if (type === 'success') setTimeout(() => $status.animate({ opacity: 0 }, 300, () => $status.hide()), 2000);
                }

                function onConfigDetected(ctx) {
                    if (ctx.configDetected) return; // Prevent multiple calls
                    ctx.configDetected = true;
                    console.log('[ConfigPage] Initializing with config:', !!window.AnswerIT_Config);

                    // Load Settings
                    ctx.loadSettings();

                    // Render Supported Sites
                    const _renderSites = () => {
                        const sites = window.AnswerIT_Config?.supportedSites || [];
                        Promise.all(sites.map(async site => {
                            let urlStr = (!/^https?:\/\//i.test(site.urls[0])) ? 'https://' + site.urls[0] : site.urls[0];
                            let domain = (new URL(urlStr))?.hostname || urlStr.replace(/^https?:\/\//i, '').split('/')[0];
                            const tld = psl.get(domain);
                            const faviconUrls = [
                                `https://${domain}/favicon.ico`,
                                `https://${domain.replace(/^[^.]+\./, '')}/favicon.ico`,
                                `https://www.google.com/s2/favicons?domain=${domain}&sz=32`,
                            ];
                            let favicon = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" rx="8" fill="%23e5e7eb"/><text x="16" y="22" text-anchor="middle" font-size="18" fill="%23667eea" font-family="Arial">üåê</text></svg>';
                            for (let url of faviconUrls) try {const res = await fetch(url, { method: 'HEAD', mode: 'no-cors' });if (res.ok || res.type === 'opaque') { favicon = url; break; }} catch { }
                            const $card = $('<a>').addClass('site-card').attr('href', `https://${site.urls[0]}`).attr('target', '_blank').html(`<img class="site-favicon" src="${favicon}" alt="${site.name}"><h3>${site.name}</h3>`);
                            $('#sitesGrid').append($card);
                        }));
                    }; _renderSites();
                }
            }

            initEventListeners() {
                $('#themeToggle').on('click', () => this.theme.toggleTheme());
                $('#apiForm').on('submit', (e) => { e.preventDefault(); this.apiKey.save(); });
                $('#settingsForm').on('submit', (e) => { e.preventDefault(); this.saveSettings(); });
                $('#testKey').on('click', (e) => { e.preventDefault(); this.apiKey.test(); });
                $('#apiKey').on('input', (e) => this.apiKey.validate($(e.target).val()));
            }

            apiKey = {
                validate: (key) => {
                    const $input = $('#apiKey');
                    if (!key) { $input.attr('class', 'form-input'); return false; }
                    const valid = /^AIza[0-9A-Za-z-_]{35}$/.test(key);
                    $input.attr('class', valid ? 'form-input success' : 'form-input error');
                    return valid;
                },
                test: async () => {
                    const apiKey = $('#apiKey').val().trim();
                    if (!apiKey) { showStatus('apiStatus', 'Please enter an API key first!', 'error'); return; }
                    if (!this.apiKey.validate(apiKey)) { showStatus('apiStatus', 'API key format invalid', 'warning'); return; }
                    showStatus('apiStatus', 'Testing API key...', 'warning');
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`).then( r =>
                        showStatus('apiStatus', r.ok ? '‚úÖ API key is valid!' : '‚ùå API key is invalid', r.ok ? 'success' : 'error')
                    ).catch(e => {
                        showStatus('apiStatus', `‚ùå Network error testing API key: ${e.message}`, 'error');
                    })
                },
                save: async () => {
                    const apiKey = $('#apiKey').val().trim();
                    if (!apiKey) { showStatus('apiStatus', 'Please enter an API key!', 'error'); return; }
                    this.setButtonLoading('saveApi', true);
                    this.GM.setValue('geminiApiKey', apiKey);
                    showStatus('apiStatus', '‚úÖ API key saved successfully!', 'success');
                    setTimeout(() => this.apiKey.test(), 500);
                    this.setButtonLoading('saveApi', false);
                }
            }

            loadSettings() {
                let settings = null, get = this.GM.getValue;
                if (!get) return;
                // get
                settings = {
                    apiKey: get('geminiApiKey', ''),
                    hotkey: get('hotkey', { key: 'a', modifier: 'alt' }),
                    theme: get('theme', 'light'),
                    makeAIOutputEditable: get('makeAIOutputEditable', false),
                    reflector: get('reflector', { enabled: false, lastOffer: '', lastAnswer: '' }),
                };
                showStatus('preferencesStatus', '‚úÖ Userscript detected - settings sync automatically!', 'success');

                // set
                if (settings) {
                    if (settings.apiKey) {
                        $('#apiKey').val(settings.apiKey);
                        this.apiKey.validate(settings.apiKey);
                        showStatus('apiStatus', 'API key loaded from userscript!', 'success');
                    }
                    $('#hotkey').val(settings.hotkey.key || 'a');
                    $('#theme').val(settings.theme || 'light');
                    $('#makeAIOutputEditable').prop('checked', get('makeAIOutputEditable', false));
                }

                return settings;
            };

            saveSettings() {
                const get = this.GM.getValue, set = this.GM.setValue;
                
                set('hotkey', { key: $('#hotkey').val(), modifier: 'alt' });
                set('theme', $('#theme').val());
                set('makeAIOutputEditable', $('#makeAIOutputEditable').prop('checked'));

                this.setButtonLoading('saveSettings', true);
                showStatus('preferencesStatus', '‚úÖ Settings saved successfully!', 'success');
                this.setButtonLoading('saveSettings', false);
            }

            setButtonLoading(btnId, loading) {
                const $btn = $(`#${btnId}`);
                const $text = $(`#${btnId}Text`);
                const $spinner = $(`#${btnId}Spinner`);
                $btn.prop('disabled', loading);
                $text.text(loading ? 'Saving...' : (btnId === 'saveApi' ? 'Save API Key' : 'üíæ Save Settings'));
                $spinner.css('display', loading ? 'block' : 'none');
            }
        }

        // Initialize when DOM is ready using jQuery's ready function
        $(function () {
            console.log('[ConfigPage] DOM loaded via jQuery ready, initializing ConfigManager');
            const cm = new ConfigManager();
        });
    </script>
</body>

</html>